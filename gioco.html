<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geometry Dash</title>
    <link rel="stylesheet" href="geometry.css">
</head>

<body>

    <div class="wrapper">
        <img src="img/Geometry_Dash.png" alt="Titolo" id="titolo">
        <button onclick="startGame()" class="pulsanti">PLAY</button>
        <button onclick="ins()" class="pulsanti">INSTRUCTIONS</button>
    </div>

    <div id="pulsantiLivelli">
        <button onclick="loadLevel(1)" class="pulsanti">Level 1</button>
        <button onclick="loadLevel(2)" class="pulsanti">Level 2</button>
        <button onclick="loadLevel(3)" class="pulsanti">Level 3</button>
    </div>


    <div id="instructions">
        <h2>Instructions</h2>
        <p>Press ENTER to start moving.</p>
        <p>Press SPACE to jump.</p>
        <p>Avoid black blocks front the front.</p>
        <p>Avoid red blocks at all costs!!!!.</p>
        <p>Touch the flag to win.</p>
        <button onclick="closeInstructions()" id="closeInstructions">Close</button>
    </div>
    <div id="win">
        <h1>YOU WIN</h1>
        <button onclick="restartGame()" class="pulsanti">Restart</button>
        <button onclick="showMenu()" class="pulsanti">Menu</button>
    </div>
    <button id="pauseButton" onclick="togglePause()">PAUSE</button>

    <div id="pauseMenu">
        <button onclick="resumeGame()">RESUME</button>
        <button onclick="restartGame()">RESTART</button>
        <button onclick="showMenu()">MENU</button>
    </div>

    <img src="img/Cube002.png" id="cubo" alt="cubo">
    <div id="barraNera"></div>
    <audio src="sound/1-02. Stereo Madness.mp3"></audio>
    <audio src="sound/geometry-dash-death-sound-effect.mp3"></audio>
</body>

<script src="livello1.js"></script>
<script src="livello2.js"></script>
<script src="livello3.js"></script>

<script>
    "use strict";
    let gameStarted = false;
    let gamePlaying = false;
    let sopraTerra = true;
    let sopraBlocco = false;
    let paused = false;
    let livelloVinto = false;

    let blocchi = [];
    let lavas = [];
    let bandiere = [];

    let audioLivello = document.getElementsByTagName("audio")[0];
    let audioMorte = document.getElementsByTagName("audio")[1];

    function startGame() {

        let playButton = document.querySelectorAll("button")[0];
        let insButton = document.querySelectorAll("button")[1];

        let pauseButton = document.getElementById("pauseButton");
        let pulsantiLivelli = document.getElementById("pulsantiLivelli");

        playButton.style.visibility = "hidden";
        insButton.style.visibility = "hidden";
        pulsantiLivelli.style.display = "block";
        pauseButton.style.display = "none";


        gameStarted = false;
        document.addEventListener('keydown', inter);
    }
    function loadLevel(level) {

        startGame();
        switch (level) {
            case 1:
                livello1();
                break;
            case 2:
                livello2();
                break;
            case 3:
                livello3();
                break;
        }
    }
    function livello1() {
        let pulsantiLivelli = document.getElementById("pulsantiLivelli");
        pulsantiLivelli.style.display = "none";
        let titolo = document.getElementById("titolo");
        titolo.style.display = "none";
        let pauseButton = document.getElementById("pauseButton");
        pauseButton.style.display = "block";
        blocchi = [];
        lavas = [];
        bandiere = [];
        gameStarted = true;
        posizionaBlocchi();
        posizionaLava();
        posizionaBandiera();
    }
    function livello2() {
        let pulsantiLivelli = document.getElementById("pulsantiLivelli");
        pulsantiLivelli.style.display = "none";
        let titolo = document.getElementById("titolo");
        titolo.style.display = "none";
        let pauseButton = document.getElementById("pauseButton");
        pauseButton.style.display = "block";
        blocchi = [];
        lavas = [];
        bandiere = [];
        gameStarted = true;
        posizionaBlocchi2();
        posizionaLava2();
        posizionaBandiera2();
    }
    function livello3() {
        let pulsantiLivelli = document.getElementById("pulsantiLivelli");
        pulsantiLivelli.style.display = "none";
        let titolo = document.getElementById("titolo");
        titolo.style.display = "none";
        let pauseButton = document.getElementById("pauseButton");
        pauseButton.style.display = "block";
        blocchi = [];
        lavas = [];
        bandiere = [];
        gameStarted = true;
        posizionaBlocchi3();
        posizionaLava3();
        posizionaBandiera3();
    }
    //FUNZIONI PULSANTE INSTRUCTIONS
    function ins() {
        let instructions = document.getElementById("instructions");
        instructions.style.display = "block";
    }
    function closeInstructions() {
        let instructions = document.getElementById("instructions");
        instructions.style.display = "none";
    }
    //*************************************************************************************************
    //FUNZIONE PULSANTE MENU
    function showMenu() {
        let titolo = document.getElementById("titolo");
        let playButton = document.querySelectorAll("button")[0];
        let insButton = document.querySelectorAll("button")[1];
        let menuButton = document.getElementById("menuButton");
        let pauseButton = document.getElementById("pauseButton");
        let pauseMenu = document.getElementById("pauseMenu");
        let win = document.getElementById("win");

        titolo.style.visibility = "visible";
        playButton.style.visibility = "visible";
        insButton.style.visibility = "visible";
        titolo.style.display = "block"
        pauseButton.style.display = "none";
        pauseMenu.style.display = "none";
        win.style.display = "none";

        riavviaGioco();
        gameStarted = false;
        gamePlaying = false;

        blocchi.forEach(blocco => {
            blocco.style.display = "none";
        });
        lavas.forEach(lava => {
            lava.style.display = "none";
        });
        bandiere.forEach(bandiera => {
            bandiera.style.display = "none";
        });
    }
    function togglePause() {
        let pauseMenu = document.getElementById("pauseMenu");
        if (paused) {
            resumeGame();
        } else {
            pauseGame();
        }
    }
    function pauseGame() {
        paused = true;
        clearInterval(timerSfondo);
        clearInterval(timerOggetti);
        clearInterval(timerLava);
        clearInterval(timerBandiera);
        gamePlaying = false;
        document.getElementById("pauseMenu").style.display = "block";
        audioLivello.pause();
    }
    function resumeGame() {
        paused = false;
        gamePlaying = true;
        document.getElementById("pauseMenu").style.display = "none";
        timerSfondo = setInterval(muoviSfondo, 8);
        timerOggetti = setInterval(muoviOggetti, 8);
        timerLava = setInterval(muoviLava, 8);
        timerBandiera = setInterval(muoviBandiera, 8);
        audioLivello.play();
    }
    function restartGame() {
        let pulsantiLivelli = document.getElementById("pulsantiLivelli");
        pulsantiLivelli.style.display = "none";
        paused = false;
        gamePlaying = true;
        document.getElementById("pauseMenu").style.display = "none";
        document.getElementById("win").style.display = "none";
        riavviaGioco();
    }
    function schermataVittoria() {
        let win = document.getElementById("win");
        win.style.display = "block";
    }
    //FUNZIONE MUOVI SFONDO
    let sinistra = 0;
    function muoviSfondo() {
        let sfondo = document.querySelector("body");
        sinistra -= 5;
        sfondo.style.backgroundPositionX = `${sinistra}px`;
    }
    //*************************************************************************************************
    //FUNZIONE MUOVI LAVA
    function muoviLava() {
        lavas.forEach(lava => {
            let sinistraLava = parseInt(lava.style.left);
            sinistraLava -= 5;
            lava.style.left = `${sinistraLava}px`;
        });
        controllaCollisioni();
    }
    //FUNZIONE MUOVI LAVA
    function muoviBandiera() {
        bandiere.forEach(bandiera => {
            let sinistraBandiera = parseInt(bandiera.style.left);
            sinistraBandiera -= 5;
            bandiera.style.left = `${sinistraBandiera}px`;
        })
        controllaCollisioni();
    }
    //*************************************************************************************************
    //FUNZIONE MUOVI OGGETTI
    function muoviOggetti() {
        let cubo = document.querySelector("#cubo");
        let cuboRect = cubo.getBoundingClientRect();
        blocchi.forEach(blocco => {
            let sinistraBlocco = parseInt(blocco.style.left);
            sinistraBlocco -= 5;
            blocco.style.left = `${sinistraBlocco}px`;
        });
        controllaCollisioni();
        if (cuboRect.bottom + 50 > 871) {
            sopraTerra = true;
        }
    }
    //*************************************************************************************************
    function gravitaSlide() {
        let cubo = document.querySelector("#cubo");
        let cuboRect = cubo.getBoundingClientRect();
        blocchi.forEach(blocco => {
            let bloccoRect = blocco.getBoundingClientRect();
            if (cuboRect.left < bloccoRect.left + bloccoRect.width && cuboRect.right > bloccoRect.left) {
                cubo.style.bottom = `${871 - bloccoRect.top + 42}px`;
            }
        });
    }
    function gravitaTorna() {
        let cubo = document.querySelector("#cubo");
        let cuboRect = cubo.getBoundingClientRect();
        let cuboStyleBottom = parseInt(window.getComputedStyle(cubo).bottom);

        blocchi.forEach(blocco => {
            let bloccoRect = blocco.getBoundingClientRect();
            if (cuboRect.right > bloccoRect.right) {
                cubo.style.bottom = 40 + "px";
            }
        });
    }

    //FUNZIONE CONTROLLO COLLISSIONI
    function controllaCollisioni() {
        let cubo = document.querySelector("#cubo");
        blocchi.forEach(blocco => {
            if (collisioneLaterale(cubo, blocco)) {
                riavviaGioco();
                audioMorte.play();
            }
            if (collisioneSuperiore(cubo, blocco)) {
                gravitaSlide();
                sopraBlocco = true;
                sopraTerra = false;
            }
            if (collisioneFinale(cubo, blocco)) {
                gravitaTorna();
                sopraBlocco = false;
            }
        });
        lavas.forEach(lava => {
            if (collisioneTotale(cubo, lava)) {
                riavviaGioco();
                audioMorte.play();
            }
        });
        bandiere.forEach(bandiera => {
            if (collisioneTotale(cubo, bandiera)) {
                schermataVittoria();
                clearTimeout(timerSfondo);
                clearTimeout(timerOggetti);
                clearTimeout(timerLava);
                clearTimeout(timerBandiera);
                audioLivello.pause();
            }
        });
    }

    //*************************************************************************************************
    //FUNZIONE COLLISIONE LATERALE
    function collisioneLaterale(obj1, obj2) {
        let cubo = obj1.getBoundingClientRect();
        let blocco = obj2.getBoundingClientRect();
        return (
            cubo.x + cubo.width == blocco.x
            &&
            cubo.bottom > blocco.top &&
            cubo.top < blocco.bottom
        );
    }
    //*************************************************************************************************
    //FUNZIONE COLLISIONE DALL'ALTO
    function collisioneSuperiore(obj1, obj2) {
        let cubo = obj1.getBoundingClientRect();
        let blocco = obj2.getBoundingClientRect();
        return (
            cubo.y + cubo.height > blocco.y &&
            cubo.y + cubo.height < blocco.y + 30 &&
            cubo.x + cubo.width > blocco.x &&
            cubo.x < blocco.x + blocco.width
        );
    }
    function collisioneFinale(obj1, obj2) {
        let cubo = obj1.getBoundingClientRect();
        let blocco = obj2.getBoundingClientRect();
        return (
            cubo.right > blocco.right + cubo.width &&
            cubo.right < blocco.right + 120 &&
            cubo.bottom + cubo.height + 10 > blocco.bottom
        );
    }
    function collisioneTotale(obj1, obj2) {
        let coll = true;
        let img1 = obj1.getBoundingClientRect();
        let img2 = obj2.getBoundingClientRect();
        if (img1.y > img2.y + img2.height) {
            coll = false;
        }
        if (img2.x + img2.width < img1.x) {
            coll = false;
        }
        if (img1.x + img1.width < img2.x) {
            coll = false;
        }
        if (img1.y + img1.height < img2.y) {
            coll = false;
        }
        return coll;
    }
    //************************************************************************************************
    //FUNZIONE RIAVVIA GIOCO
    function riavviaGioco() {
        clearInterval(timerLava);
        clearInterval(timerOggetti);
        clearInterval(timerSfondo);
        clearInterval(timerBandiera);
        audioLivello.pause();

        let cubo = document.querySelector("#cubo");
        yCubo = 40;
        rotazione = 0;
        cubo.style.bottom = `${yCubo}px`;
        cubo.style.transform = `rotate(${rotazione}deg)`;
        blocchi.forEach(blocco => {
            blocco.style.left = blocco.dataset.posizioneOriginaleX + "px";
            blocco.style.bottom = blocco.dataset.posizioneOriginaleY + "px";
        });
        lavas.forEach(lava => {
            lava.style.left = lava.dataset.posizioneOriginaleX + "px";
            lava.style.bottom = lava.dataset.posizioneOriginaleY + "px";
            lava.style.width = lava.dataset.widthOriginale + "px";
        });
        bandiere.forEach(bandiera => {
            bandiera.style.left = bandiera.dataset.posizioneOriginaleX + "px";
            bandiera.style.bottom = bandiera.dataset.posizioneOriginaleY + "px";
            bandiera.style.width = bandiera.dataset.widthOriginale + "px";
        });
        gameStarted = true;
        gamePlaying = false;
    }
    //*************************************************************************************************
    //FUNZIONE TIMER PRESSIONE PULSANTE
    let timerSfondo;
    let timerOggetti;
    let timerLava;
    let timerBandiera;
    let yCubo = 40;
    let cCubo = 0;
    let rotazione = 0;
    let bloccoRect;
    function inter(mkz) {
        let cubo = document.querySelector("#cubo");
        let cuboRect = cubo.getBoundingClientRect();
        blocchi.forEach(blocco => {
            bloccoRect = blocco.getBoundingClientRect();
        });
        if (gameStarted && !gamePlaying && mkz.key == "Enter") {
            gamePlaying = true;
            audioLivello.play();
            timerSfondo = setInterval(muoviSfondo, 8);
            timerOggetti = setInterval(muoviOggetti, 8);
            timerLava = setInterval(muoviLava, 8);
            timerBandiera = setInterval(muoviBandiera, 8);
        }
        if (gamePlaying && (sopraBlocco || sopraTerra) && mkz.key == " ") {
            if (cCubo == 0) {
                yCubo += 200 + (871 - cuboRect.bottom);
                rotazione += 90;
                cubo.style.bottom = yCubo + "px";
                cubo.style.transform = `rotate(${rotazione}deg)`;
                setTimeout(() => {
                    yCubo -= 200 + (871 - cuboRect.bottom);
                    cubo.style.bottom = yCubo + "px";
                    cCubo = 0;
                    sopraBlocco = false;
                    sopraTerra = false;
                }, 500);
                cCubo = 1;
            }
        }
        if (mkz.key == "Escape") {
            togglePause();
        }
    }

</script>


</html>